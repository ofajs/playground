<template component>
  <l-m src="/nos/n-icon/n-icon.html"></l-m>
  <style>
    :host {
      display: block;
      container-type: inline-size; /* 启用基于内联尺寸（通常是宽度）的容器查询 */
      border-radius: 8px;
      border: 1px solid var(--md-sys-color-on-normal);
      overflow: hidden;
    }

    .outer {
      display: flex;
    }

    @container (max-width: 640px) {
      .outer {
        flex-direction: column;
      }
    }

    .container {
      flex: 1;
    }

    .container {
      border-left: 1px solid var(--md-sys-color-normal-container);
    }
    .container:first-child {
      border-left: none;
    }

    .top-bar {
      display: flex;
      align-items: center;
      height: 32px;
      background-color: var(--md-sys-color-on-normal);
    }

    .top-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: 4px;
      height: 28px;
      width: 28px;
      font-size: 16px;
      border-radius: 20px;
      cursor: pointer;
    }
    .top-btn:hover {
      background-color: var(--md-sys-color-normal-container);
    }

    .content {
      padding: 8px;
      min-height: 260px;
    }

    iframe {
      display: block;
      width: 100%;
      height: 100%;
      border: none;
    }
  </style>
  <div class="outer">
    <div class="container">
      <div class="top-bar"></div>
      <div class="content">demo-code</div>
    </div>
    <div class="container">
      <div class="top-bar">
        <div class="top-btn">
          <n-icon icon="mdi:reload"></n-icon>
        </div>
        <div class="top-btn">
          <n-icon icon="majesticons:open"></n-icon>
        </div>
      </div>
      <div class="content">
        <o-if :value="previewPath">
          <iframe attr:src="previewPath"></iframe>
        </o-if>
        <o-else-if :value="frameId">
          <iframe
            attr:src="'./writer.html?frameId=' + frameId"
            frameborder="0"
          ></iframe>
        </o-else-if>
      </div>
    </div>
  </div>

  <script>
    export default async ({ load }) => {
      const { getHash } = await load("/nos/util/hash/get-hash.js");

      return {
        tag: "o-demo-code",
        data: {
          previewPath: null, // 预览路径
          frameId: null, // 组件id
        },
        proto: {
          // 获取代码并进行格式化等操作
          async getFileContent() {
            const templates = this.all("template");

            const files = await Promise.all(
              templates.map(async (temp) => {
                const path = temp.attr("path");
                const isComponent = temp.attr("component") !== null;
                const isPage = temp.attr("page") !== null;

                let content = temp.html;

                // 获取内容hash
                const contentHash = await getHash(content);

                if (!isComponent && !isPage) {
                  // 加上样式
                  content += `<link rel="stylesheet" href="https://core.noneos.com/nos-tool/css/palette.css" />`;
                  content += `<link rel="stylesheet" href="https://core.noneos.com/nos-tool/css/theme.css" />`;
                }

                return {
                  contentHash,
                  path,
                  content,
                  isComponent,
                  isPage,
                };
              }),
            );

            // 计算总hash
            const totalHash = await getHash(
              files.map((item) => item.contentHash).join(""),
            );

            return {
              files,
              totalHash,
            };
          },
          async initPreview() {
            const data = await this.getFileContent();

            // 等待系统安装完成
            await this._systemInstalled;

            // 传递文件到对面的writer.html
            this.shadow.$("iframe").ele.contentWindow.postMessage({
              type: "get-file-content",
              data,
            });
            {
              let f;
              $(window).on(
                "message",
                (f = (e) => {
                  if (
                    e.data.type === "preview-url" &&
                    e.data.frameId === this.frameId
                  ) {
                    this.previewPath = e.data.url;
                    // 移除事件监听
                    $(window).off("message", f);
                  }
                }),
              );
            }
          },
        },
        ready() {
          this.frameId = Math.random().toString(36).slice(2);

          this._systemInstalled = new Promise((resolve) => {
            let f;
            window.addEventListener(
              "message",
              (f = (e) => {
                if (e.data.type === "system-installed") {
                  if (e.data.frameId !== this.frameId) {
                    return;
                  }
                  resolve();
                  // 移除事件监听
                  window.removeEventListener("message", f);
                }
              }),
            );
          });
        },
        async attached() {
          this.initPreview();
        },
      };
    };
  </script>
</template>
