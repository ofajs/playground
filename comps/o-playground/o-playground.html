<template component>
  <style>
    :host {
      position: relative;
      display: block;
      container-type: inline-size; /* 启用基于内联尺寸（通常是宽度）的容器查询 */
      border-radius: 8px;
      border: 1px solid var(--md-sys-color-primary);
      overflow: hidden;
    }

    .outer {
      width: 100%;
      height: 100%;
      display: flex;
    }

    .container {
      position: relative;
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 200px;
    }

    .container {
      border-left: 1px solid var(--md-sys-color-primary);
    }

    @container (max-width: 640px) {
      .outer {
        display: block;
      }
      .container {
        border-left: none;
      }
    }

    .container:first-child {
      border-left: none;
    }

    .top-bar {
      display: flex;
      align-items: center;
      height: 32px;
      padding: 0 8px;
      color: var(--md-sys-color-on-primary);
      background-color: var(--md-sys-color-primary);
    }

    .top-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 4px;
      height: 28px;
      width: 28px;
      font-size: 16px;
      border-radius: 20px;
      cursor: pointer;
      color: inherit;
    }
    .top-btn:hover {
      color: var(--md-sys-color-primary-container);
      background-color: var(--md-sys-color-on-primary-container);
    }

    .content {
      position: relative;
      flex: 1;
    }

    iframe {
      display: block;
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      border: none;
    }

    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid var(--md-sys-color-surface, #f3f3f3);
      border-top: 2px solid var(--md-sys-color-primary, #3498db);
      border-radius: 50%;
      animation: spin 0.5s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }

    .mask {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: var(--md-sys-color-surface);
      z-index: 3;
    }

    .hide {
      display: none;
    }

    .tabs {
      display: flex;
      flex-wrap: wrap;
      flex: 1;
      height: 100%;
      user-select: none;
    }
    .tab {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      padding: 0 8px;
      font-size: 12px;
      cursor: pointer;
      color: inherit;
      margin-right: 2px;
    }

    .tab:hover {
      color: var(--md-sys-color-primary-container);
      background-color: var(--md-sys-color-on-primary-container);
    }

    .tab.active {
      color: var(--md-sys-color-primary-container);
      background-color: var(--md-sys-color-on-primary-container);
      &:before {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 2px;
        background-color: var(--md-sys-color-primary-container);
      }
    }

    .tab.hide {
      display: none;
    }

    .tips {
      position: absolute;
      z-index: 3;
      right: 8px;
      top: 8px;
      display: flex;
      align-items: center;
      transition: all 0.3s ease-in-out;
      padding: 4px 8px;
      border-radius: 20px;
      background-color: var(--md-sys-color-primary-container);
    }

    .hide-tips {
      opacity: 0;
      pointer-events: none;
    }

    .tips-text {
      margin-left: 4px;
      font-size: 12px;
    }

    .top-setting-tips {
    }
  </style>
  <div class="mask" class:hide="isPreviewReady">
    <div class="spinner"></div>
  </div>
  <div class="outer">
    <div class="container" style="height: var(--editor-height)">
      <div class="top-bar">
        <div class="tabs">
          <o-fill :value="fileItems">
            <div
              class="tab"
              on:click="$host.handleTabClick($data)"
              class:active="$host.activeFilePath === $data.path"
              class:hide="$host.hideUnimportantFiles && $data.unimportant"
            >
              <o-if :value="$host.previewFileItemPath === $data.path">
                <n-icon
                  icon="lets-icons:view"
                  style="margin-right: 4px; font-size: 16px"
                ></n-icon>
              </o-if>
              {{$data.path}}
            </div>
          </o-fill>
        </div>
        <div class="top-btn" on:click="showConfig = true">
          <n-icon icon="uil:setting"></n-icon>
        </div>
      </div>
      <div class="content">
        <div class="tips" class:hide-tips="!hasUnsavedChanges">
          <n-icon icon="material-symbols:save-outline"></n-icon>
          <div class="tips-text">
            <o-if :value="isMac"> cmd + s </o-if>
            <o-else> ctrl + s </o-else>
          </div>
        </div>
        <o-if :value="isPreviewReady">
          <iframe
            attr:src="'./code.html?totalHash=' + totalHash + '&activeFilePath=' + activeFilePath"
            id="code-frame"
          ></iframe>
        </o-if>
      </div>

      <style>
        .setting-dialog {
          position: absolute;
          z-index: 2;
          width: 100%;
          height: 100%;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: all 0.3s ease-in-out;
          background-color: rgba(
            from var(--md-sys-color-normal-container) r g b / 0.5
          );
          user-select: none;
        }
        .hide {
          opacity: 0;
          pointer-events: none;
        }

        .setting-content {
          padding: 16px;
          border-radius: 8px;
        }
      </style>

      <div
        class="setting-dialog"
        on:click="showConfig = false"
        class:hide="!showConfig"
      >
        <div class="setting-content" on:click="$event.stopPropagation()">
          <label>
            <input type="checkbox" sync:checked="hideUnimportantFiles" />
            Hide unimportant files
          </label>
        </div>
      </div>
    </div>
    <div class="container" style="height: var(--preview-height)">
      <div class="top-bar">
        <o-if :value="previewPath">
          <div class="top-btn" on:click="handleReloadClick">
            <n-icon icon="mdi:reload"></n-icon>
          </div>
          <a class="top-btn" attr:href="previewPath" target="_blank">
            <n-icon icon="majesticons:open"></n-icon>
          </a>
        </o-if>
      </div>
      <div class="content">
        <o-if :value="previewPath">
          <iframe attr:src="previewPath"></iframe>
        </o-if>
        <o-else-if :value="!!previewFrameId">
          <iframe
            id="writer-frame"
            attr:src="'./writer.html?frameId=' + previewFrameId"
            src="./code.html"
            on:load="handleWriterFrameLoad"
          ></iframe>
        </o-else-if>
      </div>
    </div>
  </div>

  <o-consumer name="pui" watch:theme="theme"></o-consumer>

  <script>
    import { prefixContent } from "./public.js";
    export default async ({ load, url }) => {
      // 等待系统安装完成
      const systemInstalled = new Promise((resolve) => {
        let systemInstalledHandler;
        window.addEventListener(
          "message",
          (systemInstalledHandler = (e) => {
            if (e.data.type === "system-installed") {
              writerFrame.remove();
              window.removeEventListener("message", systemInstalledHandler);
              resolve();
            }
          }),
        );

        const urlObj = new URL("./writer.html", url);
        const writerFrame = $(
          `<iframe src="${urlObj.href}" style="display: none;"></iframe>`,
        );
        $("body").push(writerFrame);
      });

      // 检查本地是否已安装nos
      const hasLocalInstallation = await fetch("/nos/nos.json")
        .then((res) => res.json())
        .catch(() => null);

      const configData = await fetch("/__config")
        .then((res) => res.json())
        .catch(() => null);

      // 统一资源前缀，避免重复拼接
      const localPrefix = location.origin;
      const remotePrefix = "https://core.noneos.com";

      const prefix =
        hasLocalInstallation && configData?.serviceWorkerVersion
          ? localPrefix
          : remotePrefix;

      // 并行加载图标组件与哈希工具，减少等待时间
      const [, { getHash }] = await Promise.all([
        load(`${prefix}/nos/n-icon/n-icon.html`),
        load(`${prefix}/nos/util/hash/get-hash.js`),
      ]);

      return {
        tag: "o-playground",
        data: {
          theme: "",
          fileItems: [],
          activeFilePath: null, // 查看代码的文件路径
          previewFileItemPath: null, // 预览文件项
          previewPath: null, // 预览路径
          previewFrameId: null, // 预览框架ID
          totalHash: null,
          isPreviewReady: false,
          hasUnsavedChanges: false,
          isMac: navigator.userAgent.indexOf("Mac") !== -1,
          errorMessage: "",
          showConfig: false, // 是否显示配置弹窗
          hideUnimportantFiles: true, // 是否隐藏不重要的文件
        },
        watch: {
          theme(theme) {
            this.sendTheme();
          },
        },
        proto: {
          handleTabClick(tab) {
            if (tab.active) {
              return;
            }

            this.fileItems.forEach((file) => (file.active = false));
            this.activeFilePath = tab.path;
          },
          sendTheme() {
            this.shadow.$("#code-frame") &&
              this.shadow.$("#code-frame").ele.contentWindow.postMessage(
                {
                  type: "setTheme",
                  theme: this.theme,
                },
                "*",
              );
          },
          handleWriterFrameLoad(e) {
            if (this._isWriterFrameLoaded) {
              return;
            }

            this._isWriterFrameLoaded = true;

            if (this._isComponentVisible) {
              this.initPreview();
            }
          },
          handleReloadClick() {
            if (this._isReloadInProgress) {
              return;
            }
            this._isReloadInProgress = true;
            const url = this.previewPath;
            this.previewPath = "";
            setTimeout(() => {
              this.previewPath = url;
              this._isReloadInProgress = false;
            }, 100);
          },
          // 获取代码并进行格式化等操作
          async getFileContent() {
            const codes = this.all("code");

            const files = await Promise.all(
              codes
                .map(async (codeEl) => {
                  let path = codeEl.attr("path");

                  if (!path) {
                    if (codes.length === 1) {
                      // 如果只是一个案例，则进行额外补充文件，修正path
                      path = "demo.html";
                    } else {
                      return;
                    }
                  }

                  const firstCodeChild = codeEl[0];

                  const isComponent =
                    firstCodeChild &&
                    firstCodeChild.attr("component") !== null;
                  const isPage =
                    firstCodeChild && firstCodeChild.attr("page") !== null;

                  let content = "";

                  if (isPage) {
                    content = `<template page\>${decodeHTMLEntities(firstCodeChild.html)}</template>`;
                  } else if (isComponent) {
                    content = `<template component\>${decodeHTMLEntities(firstCodeChild.html)}</template>`;
                  } else if (
                    codeEl.length === 1 &&
                    firstCodeChild.tag === "template"
                  ) {
                    // 解套
                    content = decodeHTMLEntities(firstCodeChild.html);
                  } else {
                    content = decodeHTMLEntities(codeEl.html);
                  }

                  // 获取内容hash
                  const contentHash = await getHash(content);

                  if (!isComponent && !isPage && !!firstCodeChild) {
                    // 加上样式
                    content =
                      `<link rel="stylesheet" href="https://core.noneos.com/nos-tool/css/palette.css" />` +
                      content;
                    content =
                      `<link rel="stylesheet" href="https://core.noneos.com/nos-tool/css/theme.css" />` +
                      content;
                    content =
                      `<script src="https://cdn.jsdelivr.net/gh/kirakiray/ofa.js/dist/ofa.min.js#debug"><\/script>` +
                      content;
                  }

                  const active = codeEl.attr("active") !== null;
                  const preview = codeEl.attr("preview") !== null;
                  const unimportant = codeEl.attr("unimportant") !== null;

                  return {
                    contentHash,
                    path,
                    content,
                    isComponent,
                    isPage,
                    defaultActive: active,
                    preview,
                    unimportant,
                  };
                })
                .filter((item) => !!item),
            );

            // 计算总hash
            const totalHash = await getHash(
              files.map((item) => item.contentHash).join(""),
            );

            return {
              files,
              totalHash,
            };
          },
          async initPreview() {
            const data = await this.getFileContent();

            let previewFileData = data.files.find((item) => item.preview);

            if (!previewFileData) {
              // 查不到预览文件，则查找普通文件
              previewFileData = data.files.find(
                (item) => !item.isPage && !item.isComponent,
              );
              if (previewFileData) {
                previewFileData.preview = true; // 预览文件
              }
            }

            if (data.files.length === 1) {
              data.files[0].defaultActive = true;

              // 如果只有一个文件，而且是page模块，则添加辅助加载文件
              if (!previewFileData) {
                if (data.files[0].isPage) {
                  previewFileData = {
                    path: "index.html",
                    content: `${prefixContent}\n<o-page src="./${data.files[0].path}"></o-page>`,
                    unimportant: true,
                    isComponent: false,
                    isPage: false,
                    preview: true,
                  };

                  data.files.push(previewFileData);
                }
              } else {
                previewFileData.preview = true; // 预览文件
              }
            }

            this.totalHash = data.totalHash;

            // 传递文件到对面的writer.html
            this.shadow.$("#writer-frame").ele.contentWindow.postMessage(
              {
                type: "get-file-content",
                data,
              },
              "*",
            );

            const activeFileData = data.files.find(
              (item) => item.defaultActive,
            );

            this.activeFilePath = activeFileData.path; // 查看代码的文件路径

            this.fileItems = data.files;

            await new Promise((resolve) => {
              let previewUrlHandler;
              $(window).on(
                "message",
                (previewUrlHandler = (e) => {
                  if (
                    e.data.type === "preview-url" &&
                    e.data.frameId === this.previewFrameId
                  ) {
                    this.previewFileItemPath = previewFileData.path;
                    this.previewPath = e.data.href + "/" + previewFileData.path;
                    this.isPreviewReady = true;
                    // 移除事件监听
                    $(window).off("message", previewUrlHandler);
                    resolve();
                  }
                }),
              );
            });
          },
        },
        async ready() {
          await systemInstalled;
          this.previewFrameId = Math.random().toString(36).slice(2);
        },
        async attached() {
          window.addEventListener(
            "message",
            (this._messageHandler = (e) => {
              if (e.data.type === "save-file") {
                if (e.data.totalHash !== this.totalHash) {
                  return;
                }

                this.handleReloadClick();
                this.hasUnsavedChanges = false;
              } else if (e.data.type === "change-file") {
                if (e.data.totalHash !== this.totalHash) {
                  return;
                }

                this.hasUnsavedChanges = e.data.isChanged;
              } else if (
                e.data.type === "codeFrameLoaded" &&
                e.data.totalHash === this.totalHash
              ) {
                // 发送一次主题色
                this.sendTheme();
              }
            }),
          );

          let inspectTimer = null;

          // 监听当前组件出现在可视范围时，进行初始化
          this._visibilityObserver = new IntersectionObserver(
            (entries) => {
              entries.forEach((entry) => {
                if (entry.isIntersecting) {
                  if (this._isComponentVisible) {
                    // 已经初始化过，不用再执行
                    return;
                  }

                  inspectTimer = setTimeout(() => {
                    if (this._isWriterFrameLoaded) {
                      this.initPreview();
                    }
                    this._visibilityObserver.disconnect();
                    this._isComponentVisible = true;
                  }, 300);
                } else {
                  clearTimeout(inspectTimer);
                }
              });
            },
            { threshold: 0.1 },
          );
          this._visibilityObserver.observe(this.ele);
        },
        detached() {
          this._messageHandler &&
            window.removeEventListener("message", this._messageHandler);
          this._visibilityObserver && this._visibilityObserver.disconnect();
        },
      };
    };

    const decodeHTMLEntities = (str) => {
      const textarea = document.createElement("textarea");
      textarea.innerHTML = str;
      return textarea.value;
    };
  </script>
</template>
